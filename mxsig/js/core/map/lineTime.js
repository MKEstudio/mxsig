//////////////////////////////////////////////
// Mapa Digital de MÃ©xico v6.0  //
//          //
//////////////////////////////////////////////
// eval((function(x){var d="";var p=0;while(p<x.length){if(x.charAt(p)!="`")d+=x.charAt(p++);else{var l=x.charCodeAt(p+3)-28;if(l>4)d+=d.substr(d.length-x.charCodeAt(p+1)*96-x.charCodeAt(p+2)+3104-l,l);else d+="`";p+=4}}return d})("define([\"OpenLayers\", \"config\", \"tree\", \"request` .!imer\", \"dataSource\"], function (OL, ` \\\", tree, R` X\", Timer, ` P&) {(` P&$) {$.widget(\"mdm6.lineTime\", {options:{}, _create:` S&) ` 3!init` $.setO` Y!` 0'key, value) {this.` z#[key] =` 6\";switch` J!) {case \"parte\":break;default:;}}, destroy`!4*var element = `!&!` (#;$.W`\"J!.prototype.` \\#.call(this);}});})(jQuery);var`#?! = {Tree:null, Map` ##`$?!` %#`$T#:{url:`#p&.timeLine`$)\"` H!}, map:{name:\"L`#q&server:`$p\".mapC` $\"` \\$.l`%w!, div:\"`$L$_map\", moved:true, percent:70}, ` O\":{available`$u\"addA` *$`#6.p = arguments[0];data`!9#.` `&[p` .\"] = p`$5!yea` w2` r.a` t,var y`$S$` X&;for (x in a) {if (x != \"0001\"` +#y[x]) {} else {y[x] = true;}}}}, width:48` ##Year:10}, idBtn:`(#!`)V\"_`\".!Manager_btn`$8#popup:{id`#r&\", titl`$`#a de tiempo\", clase:\"Popup-square\", visi`#m!alse, en`#z\"alse}, modal` }\"Modal`%R'`!!#Mapa din&aacute;mico: `!%&` R!-window` }.`*)\"d` '$anima`)j\"` +\"images:{`\"]!`'S#pos:0`$q$` -\"` B!:0, last:\"\", total` -!oaded:0` S!i`+D\"`'p!}, blocker`#5*B` /\"\"}, root:\"map\"}`)7\"`-s!`,i! =`-0'`%y#`&h\" =`(u!`&j.` ^!capas = []`%{'` E\"`+b!pas.push(x);}`+<!v`+9\"` }-bound`!%%Map.map.getExtent(`+*\"e` (! =` H#.toGeometry() + \"\";`!J$`!6\"toString` X#params = `#|\"s:` A!,` p#:` x\"};makeCone`!]!(` O\");}`)_\"`,1! =`0 \".`15#2000,`\"7\",`(1!,`(7!);`#d\"`,W# =`0]$.New(`,c%.` 9#.url`11!tentType:\"applic`& !/json; charset=utf-8\"`!.#s:{success`*]'response`)|#` '$.` 0$.` L#) {showYears`,K%s` F&`!^!`0}\";`*Y$}` 0!map.`-T! = `'^!;}, error`!<'e) {}}}`#|\"getS`#R\"s`%20d = new Date` K!actualYear = \"2011\"` 2\"`,i0cadena = \"\"`,f+var i = a[x];` @#+= \"<div`*6!s=\\\"item`*j$\\\">\" +` 2+`(l$SecLab\\\" style=\\\"display:non` P&span id` M'_\" + i`(e\" + \"\\\"` r%play`!4$ ui-icon u` \"\"-circle-triangle-e`!!6</span`!;#/div`!l7_view\\\">` 8!`![*view`!i!x`!Y+`!w!D`!.\"-sprite`*J\"` ,$iconEy`\"E\"(i.`-Z# ? \"a\" : \"d\"`)d!`!f8div>`!l,`#+9_label`!Y)be`/T%\\\" align=\\\"left`$9#i.` @! + \" (\" +`&>(+ \")`\"}<Slider`%Z)`!F:s` J#` a%` )$`\"?)`!+'` %\";}return`'V#`+J#getV`#T\"`3N\"`(X0result = null` Q!`/I%getSource()`/$0if (` '\"[x]`$[$`+<&` q!` q\") {` ~%[];}` '\"`/i&`!u$` 2\"`!v#setP`./!ToTimeLine`1#9`\"=,();`!X& !`!A%` H%`1e#`/r'`,O$` :%\"\";`,]\"Map.`!F'` }!(`4:#`$d%\",`0T#`4T#s:` c\"}}`/Z$addImag`!t1p`,80path = p.serv`%]\"&LAYERS=\" + p`%p&&TRANSPARANT=true&FORMAT=image/png&SERVICE=WMS&VERSION=1.1.1&`&&!REQUEST=GetMap&STYLES=&FIRM=11&SRS=EPSG:900913&BBOX`!>#`3i#+ \"&WIDTH` 0#width` 1!HEIGHT` 0#heigh` H\"TIME` /#tim`/F\"hidden`\"P!` $#? `*Q)`*|!`/Z\"`/A&<img`(l+`\"T!`(|!p.y`)j#` (#time`+Q+position:absolute;left:0px;\" +`!N$` N\" src=\\\"` g!a`\"=\"\\\">`!M\"map = $(\"#`!%\"root).append(`!j\");$(\"#`!@D).bind(\"load\",`%j*check`&-!Load`'>#`&E$getCon`$5!`&</`2Z=` #%`4\"'(a)`2g-`#g*years`#:9top:25px`#Z\"18px;right:12px;bottom:5px;z-index:-1`-4&` ;separator`!7'`&I\":20px;padding-`!5\"2` ''`!8'`!#'`-~3Interfac`)s1`#C2hain`'#!`!l%`0i!.`+Y!id`209`0#%` H'clas`'<#`0q'`1z$cent`0Y)titleOL` x'border-`#i#solid #CCCCCC `\"_#` f.`2t\"`!i3_`! !` Q#` 3#` .!`1c,span ` 5!`!f!rrar` m$`2k)` p*btnClos`\"d(clos`04!Time ui-icon u` \"\"-circle-` @!`$o!span`3/.`\"{9contOL`\"+%c`(i#`3n2`%f$hain`1}$howPopupYear`(^$`%^4[\"1960\", \"1970` \"\"8` )#9` #!200` +!2010\"`&3#`!N!ido`)p\"`34\"` %0`4N'a) {` D&+`*-(Year`!b!(a[x]`33\"x < a.length - 1` D6S`).$` ]\");}`!9%+= 2` $'-= 1`!\\#gmento = `$!`+2!`0K\"` ;!`&x\"Pixel = 2`-c*` H!\").html(\"\"`.4&`!W$`.2+`*m%\").css(\"`!#!\", (`!>%+`!&() *`#:&+ \"px\"` m!.` j$Slider\").each(`$[-id`/}!this).children(\"div\").attr(\"id\")`\"D!lon = id`#_&7;` [!id.substring(9, lon` L\"anio = parseInt(a[0]` 4\"`/2(`%2!var x = 1; x < 56; x++) {`-|&getYearsNotAvailables(anio, 10, id);`!-!+= 1;}`\"-%ss(\"`\"q!`\"/3`2B*`1K%assingEvent`'v-$(\".s`#<:`2z!= 1960` j!`#])`\"}Y` ]$`!;\"({value:51, min:0, max:54, step:1, ` D!:`!X&event, ui`!d#etiqueta`'Z$layers.a`#\\%[id].label + \" (\" + (`\"<!+ ui.`!<!) + \")\"`'A*\" + `-M#` Z!`(\"$`!*$);}, stop`!C7response = {dates:\"\", `!_!:id`$F\"items`!w$request`.m!`!u!` $!`!`+]`+4!` S!) {` |$.` |! =` k\"[0];} else`-2#`'@+`\"R,`!F!origen`!/9` C!new` i#`--(` X\"`.>'`!$%x`-%\"a <`!C!) {` X&a;}}if (` )%= 0) {` PC` \\(break;}}var posi`$.!=`!d%-`'R!`$k5`(*%`&t#\"`\"s!\",` b%);`$ F` L$];`$#7`#C#Layer =`%c%` D\"`#c!fuente`!*$Tree.getTemporalStore(`$T\"`\"E'` O\".Vectorial.item[id`2\"\"grupo` 20` Z$[`!s%.group` y\"ara`\"V![{id:id, active:true, ` D!:` v!}];`!c&addToRe` m!ory(` a\");}}`*Y-\"disable\"`,a!`$4-` o!popup.`$I#btnClose\").click`,X*toggleVisibility(` W&` y$.playL` ~#`-61`.M%` n.`-5!`$R#`-G..replace(\"`!{&, \"\");showModal(` Y!`/-\"`\"J\"`\">%idBtn`!!1if `!~'.enable`\"-=}`!1\"PopupYearS`3m#`%t#registro = {flag`$m#id`,G!`$9\":\"\"}`4.)_view`0G5reg = jQuery.extend({},`!\"%);reg.`4J2`0t)` >%` #\"`#E/view`#U$reg.flag`/r6` a\"].visible` M!`\"<\" = `$B' +`!+#`*o(`3t.`%B5item`\"3&`!M(!` $$;statusD`'q\"d({`00\"`!1\"`#o%` F$, play`$4#ey`)1$`\"!#` <'`(`#` ;!}`.Q\"`!*%) {item.removeClass(\"`!2!Display-iconEye_a\").add` '8d\")`0x%` OCd` T>a\");}`(&$`\"f\"`#]$);setP`+=!ToTimeLine(`(Z$`3F\"`\"k!`'~!`.1!Time`-'!`$7$`#U!`#s!`$B#sourc`.9%`%`-`#;!` >\"[id]) {` #&`%}$ =` l#`4e%`%5!`,V'`&~\"`1&!`$+#`!;%`#Bj`*J:`#Wr`+-`\"f&`'L2id`'6(`'L'`'l#` P\"`'R&` *\"});}`$~\"stop`$h)`/%!`#d'btn_animation`.h!`\"A'icon_stop`\"2)` 1!play\"`.f\"`!E\"-modal\").draggable(\"`\">\"` f,`!3%` S\"_` T!_`)E#`(E!`3A\"lay`!k,`%p!nfo`&\\$` V!.image`&+#` &!` 7$request.data[info`'/\"]` ,!`&8!` 0!years` :\"pos] &&` r(`\"u%`!9#year =`!B!` J,` m\"`!>![year]` 5\"` -!]`#s#`'V!`!E\"st).fadeOut`0x#` E!n =`\"!#` S.` @\"d`.T)` 5!`(N!`!V!+ \"`(Z\"` g!`3%%id`!'\"In();`!8% = id`$R0c`$E!eft\",`!i\"posi`2e!`!C.` 3% + \"px\"` y#` 8! += 1`(e&` c#` 0\"` ;'= 0;}setTimeout`07*play();}, 2000`)R'` R*` t%= 0;stop(`'~%assingEventsModal`'w9\" +`&2)`23\"btnClose\"`1t1if `+;\"`%c.`(s9`/'$`/?%`!(-,` -&blocker`/c!hid`/J#` ]?`!^)`!S0 = !` $0`'M!`!5`4L!`+ /`*w\"`+#,`+C\"`*t;`*`#`.\"*`*q<`%Y$`%Q#`%3%`+C$getS`1t$`\"^)return`1x4` W\"`08,`, 0a = arguments[0];a`2F'!` $%`)D%a`$^!` t\"(` 6%`2J\"` %& {execut`%#!`'B#ddComponents`!60`4;%`\"K%`+T#params =`%:\":`1@&, content:getC` %\"`4`#)}`!i%`.*\"oot).append(getInterface(` x\")`#f'` c#`(y1var di`!I!getDimen`+V!FromMap`!k#cadena = \"<div style=\\\"padding-top:5px;` ($bottom:2` ('left` $)righ` ,\"\\\">\" +` l+background:#DCDDDF` Q%` ~,` v!10` k-` &)`!L#` /!`!$)id=\\\"`*D&ap.div + \"\\\"`!D%width:` @!ims.` *!`.;\";he`!'!` 3%` *\"` 6#`!z'white;`.v$:relative`!B&/div`!P#/div` $.`\"r(`!/#5`\"6(top`\":!`#:1float:left`!j$100%;`\"3\"9%` ?1` m(8` i+`#1\"`,u2\\\" class` 5(icons `,)%\\\">`\"#J`#'.`!u9 90%;border: 2px solid #BBBCC0`%./`!`%`,l!`%0'`!0%absolute;`&W$`&R!5px;`&H\"5px;`&>#5`&>\"`!|7`#/+`0f\"` y9`'4(`'g&`'^'top:30`&G*`'\\z`)X/`'`\"`$$(`&X2ont-size:170%`!R)2` %'`*|#` ''`+@\"0`'&&img src=\\\"img/spinner.gif`!T2`%M!`\"*$ 10`%P&DDDDDD\\\">Cargando `'K!ci&oacute;n`&o>` %-;`2.#`-y\"`.j#clearYear`0D-$(\".`%L%year\").each(` 7+this).css(`#q'\", \"`#z!\");`3e%statusD`48#`2jAvar `3{! = `4##` /!item =`4)3[` -#` Y\"`!0\" = \"d`!4\"\"`3G#slider) {` 8&en` ;\"}$(\"#`\"T%`43\"`!A\"+ \"_` S\"\")` [#(` Z\"`4=$play`#9\"` T*` [!).show();} else` -6hide();}` n\"eye` c,view` PD` <,` o*visible != undefined) {item` 3%= ` ?%;}` 5!`#%\"` 4!`#Q#`\"[!` H*= fals`!k-`#1<`$A%);}`%t#how`'!!A`$}%`%l0items`%t,`%`!request.data =` C\";`'s&();for (x in` 7\"` k#segment` K$[x`&/\"param`'?({`\")!:x, `!~\":true, play` $#eye` ##`\"7#` )!}`#-%s[x] == null) {` `>`#V!` |#` %#eye` #$` }$` *!};}`)/*(` q*`\"W#e in`\"J$`\"Y#y`*t#` /#[e]` E\"y in` 7\") {if (y != \"0001\"`${0x`%$!year` *!y`*}1gray`%/!}`%0#getDimentionsFromMap`%$0perc`$@\"`%(!map.` ,#` b!m` Q!$(\"#map\")` /!`46! = map.` '!(` 2\"`0I\"` 2#` '\"` 3#newW` N#`!($*` `#/ 100` =$H` Z$` <&` n#` A\"`.`#{` V!:` n$,` >#:` Y%}`-o$howModal`.o/`#[&`4P#\"`*a%`-w5`-p%modal`&[!!m.creat`*T!`'V& = {data:m, content:getC` %\"`!O!()`!_\"`!8# =`2>#id=\\\"\" +`!$\"` 7#.id + \"\\\" class=\\\"ui-widget-overlay\\\"`2w%z-index:3000\\\">`1~$$(\"#` p%root).append(` #` '%getInterface`'j#));assingEvents`!|#;`\"V% = true;}`-/(`(^!`\"@\"ranch`1 5`!N*`#Z!`\"L#_title\").html(` 4'` 3!`4@!label`\"T%font-w`%L\"bold;\\\"`4h!`!<\"[a].` J\"+ \"</` &!>\");toggleVisibility(m);builSecuenceImages(a` 0\"dL`%v#`\"a\"a)`!r*`$K&`0t&`(h#keCone`&d\"`);0`&C0`&)&tablas:p`#:#, proyName:dataSource.` ,$, ex`&T!p.` #\"};`/D$setP` p!(JSON.stringify`%\"&` B$execut`2O!`+P$S`!y\"YearPopu`+B1cadena`'K%`$4$position:relative;float:left;`*0\"`#<%`-^!`+[\" + \"px;`*@#100%;border: 1px solid #DDDDDD`%'$`!\"3absolute;top:0px;left:5px;r` x!5px;bottom` 9!`.<&:#EEF0EF;`(g&` c?` `'` z\"`!*%` n,BBBCC0`!v$`%8(`'$\"`!(&`*'#`-F#`#d\"`$--Separato`$-2` U#`#;~`$4%FFFFF`#1(`!h&YearsNotA`*e%`%o?`-a!`2{)`#)&2`#.!`3)&`#=,`-{'` Y%year`-w'`\"O'`\"e.`\"b&` p&1` u!`\"^&8px;`._$1`\"K'`$B0check`+\\!Loading`\"L0info`12).i`,.!;info.loaded += 1`1R!` )(==` X!.total + 1`2G6fadeOut();}`!T#alculateE`+=!`!E0factorL`,k!28000`4i#` 1#at = 21` .&centroid`\"%$Map.map.getCenter`3{#px2 =` E%.lon +`!#&` =\"y` 5*at` 9&at` _#1` V,-` U-` 5*at` 9&at`$J$px1 + \",\" +` M!` #%x2` -'2`$l#`0I.`#'0`/A!`/^0map = `$8)map\");map`2c\"\"\"`# \"`/T\"`#9/`$K\"`#E#s`05!` >$`/T$data[`!?!]` '!` F!`*.\"= map`*:\"` \\#`'R\"` 2#` '\"` 3#`!=\"`\"A! =` '#.left`\"o%` -#`-G\"` &,`-S!` %,top` w!`+c! = [];for (x in`\"'#) {if (x != \"0001\") {`,2\"push(x * 1);}}`(B-`(0% 0;` +.`(A\"= `'(\"`3r&root:`+'&map\", server:config.mapC` $\"timeLine.base.url,`%'\"` *<` @!,`#\":`#z!,`#s#:`#n\",`\"{#:`#k',`#\"!:\"base\", time:\"\", hidden:false};add` I!(`\"-\")`#F'`#1!`+`$`'&$`#`\"[` 7![x]`#z#i in` =#` J#`\"\\B`#b\"ap.` *\"`\"g$`!tX`!R$`\"K#`!O\"[i]`\"P%tru`\"D0`${4`-x!`%Z1`)`#` #!` L/`&}$` #!`*V'dL`\"d#Mod`&.!`*P-`0t$`#:!` S\"`*[5`)]C`+'*odal\")`+%*`*:$` 51`*L# - 4` H!arreglo`)=\"` &'P`!o'`)5D` T#`)P+`\"7!egmento =`!W#/`! $.length`1F#dena = \"\"` *\"ount`#(!`)f\"bandera = true`!I'` e#) {` 9&!` $#` c#lor =` Y%? \"white\" : \"#C9C8CD`!,$lorinsid`!4!` F'#CBCCCE` M\"A3A4A8\";`!l#+= \"<div style=\\\"`%1$:relative;float:left;`((\"\" +`\"n&+ \"px;`(3#100%;background` E!`!|\"+ \"\\\">\" +` ,adding-top:14px;\\\">` 4)` Z0`\">$` k&`#A#[x]` }!/div></div`!,#` %\"`##!ite`*p!`&p9[` g&`&7\"reg`&%(`+g\"tems) {`%&$+=`\"m&/` 8\"`%Y(registro = {`#]%` U#,` J!:` O!`+$!`+C!`!;&};`'N,`'&\"` l$);reg` #-}`)}%`\"$( =`\")!;`+=/`*J(` #%`*>\"l`&1#`$Y\"id=\\\"` .\"-` ]!\\\"`%p. absolute; top: -6px;`.+# 20px;`.*$ 52`%(/` `%` _%`%B'`(!!;top:0px;left` $!`4O!` %!`&k$9px;border: 1px solid black` o?` y$` r\"4`!#$3` p!ttom` %\"`!N&gray\\\"`&V#`&b#`!fK` r#`!y;8`!W]3`!{90`!v>`(o#`/?6`+]$`%x#)` F!`%k(\").draggable({axis:\"x\", containment:` l-, cursor:\"pointer\", stop:`1|&event, ui`2(#result = null`.N.`(m%`07#ui`(\"%.left <=` :-[x]` <%) {` y%` 5/;break;}}if (` B#!`!F\") {$(\"#\" +`,+\"`)B)last).fadeOut(`2~\"id = \"`\"i%` E!_\" +`\"<#.yea`-T!` ((item`#v!\" + id` m\"In();` ~2 = id;}}});}`*X\"etMovedMap = `#]&) {` \\\"ap.moved`\"[!guments[0]` X#execute` K,if (` Z!timer &&`\"]\"popup.visible` -%` z%`!,$` P!.` t#();}`!d#petialModul`!$*capas`%I#`#!!= 196`4;\"`/v!s = ` @!.split(\",\"`#n\"source`0L$` F\".available`-[\"`-o(`0>$`&>!` I\"`\"H#` d\"`1$\"s[x]]`\"`#` '-`\"X$`&5!pla`!:!true`!(!valor = `)-)\" +`!&#`2`#_`)$\"\").` #\"(\"option\", \"value`\"8#newLay`/Y!`2^3`!M\"` +!`&9#`!=!];if (` W$) {`#9!`#=%`!r#(` Z%,`!\"%[0]);} else`2c&`1y#x);}}`(F\"` 0&`3B\" > 0) {`#X!`((!`1\\(`3d$ i >= 0; i--) {`$H#splice` h&`3a!1);`!k$` @#toString`&,!return`\"(\"`'D#init`'n1`(5\"`'p)` 3!Tree` ,)1];addComponents();assingEv` (#def`$m#r();`'X&`'a2;`!_#{load:init,`))$:` @#, add`#s!A`'-$:`'>)dd` 0%, get` G!s:getV`&a\"` +\",`*](:`*j'` 4!` F!ility` I!Time:`'A!` &*,`)U*:`)d)};});"))
define(['OpenLayers','config','tree','request','timer','dataSource'],function(OL,config,tree,Request,Timer,dataSource) {
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    (function($){
        $.widget("mdm6.lineTime",{
            options:{
            },
            _create:function(){
               
            },
            _init:function(){
                
            },
             _setOption:function(key,value){
                this.options[key]=value;
                switch(key){
                    case "parte":
                    break;
                }
            },
            destroy:function(){
                var element = this.element;
                $.Widget.prototype.destroy.call(this);
            }
        });
    })(jQuery);
   
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    var data = {
        Tree:null,
        Map:null,
        timer:null,
        request:{
            //url:'http://127.0.0.1/TableAliasV60/lineatiempo',
            url:'json/linetime.do',
			url:dataSource.timeLine,
            data:null,
        },
        map:{
            name:'LineTime',
            server: config.mapConfig.timeLine.layers,//config.mapConfig.layers.time,
            div:'lineTime_map',
            moved:true,
            percent:70
        },
        layers:{
            availables:{},
            addAvailable:function(){
                var p = arguments[0];
                data.layers.availables[p.layer]=p;
            }
        },
        years:{
            availables:{},
            add:function(){
                var a = arguments[0];
                var y = this.availables;
                for(x in a){
                    if(x!='0001'){
                        if(y[x]){
                        }else{
                            y[x]=true;
                        }
                    }
                }
            },
            width:48,// 1px por cada border -> width =50
            widthYear:10
        },
        idBtn:'mdm6Layers_layerManager_btnTime',
        popup:{
            id:'lineTime',
            title:'Linea de tiempo',
            clase:'Popup-square',
            visible:false,
            enable:false
        },
        modal:{
            id:'ModalLineTime',
            title:'Mapa din&aacute;mico: ',
            clase:'Modal-window',
            visible:false,
            created:false,
            animation:false,
            images:{
                layer:null,
                pos:0,
                years:null,
                image:0,
                last:'',
                total:0,
                loaded:0,
                positions:null
            }
            
        },
        blocker:{
            id:'lineTimeBlocker'
        },
        
        root:'map'//source
    };
    var defineTimer = function(){
        var layers = data.layers.availables;
        var capas=[];
        for(x in layers){
            capas.push(x);
        }
        var event = function(){
            var bounds = data.Map.map.getExtent();
            var extent = bounds.toGeometry()+"";
            
            capas = capas.toString();
            var params = {layers:capas,extent:extent}
            makeConection(params);
        }
        data.timer = Timer.define(1000,event,true,true);
    };
    var request = Request.New({
        url:data.request.url,
        contentType:"application/json; charset=utf-8",
        events:{
            success:function(response){
                if(response.response.success){
                    showYearsAvailables(response.data.value);
                }else{
                    //console.log(response.message);
                }
                data.map.moved=false;
            },
            error:function(e){
                ////console.log('error lineTime')
            }
        }
    });
    var getSections = function(){
        var d = new Date();
        var actualYear = '2015';// d.getFullYear(); 
        var a = arguments[0];
        var cadena='';
        for(x in a){
            var i = a[x];
			cadena+= '<div class="itemLineTime">'+
                                    '<div class="lineTimeSecLab" >'+//style="display:none"
                                        '<span id="lineTime_'+i.layer+'" class="playLineTime ui-icon ui-icon-circle-triangle-e" style="display:none"></span>'+
                                    '</div>'+
                                    '<div class="lineTime_view"><div id="lineTime_view_'+x+'" class="layerDisplay-sprite layerDisplay-iconEye_'+((i.visible)?'a':'d')+'" style="display:none"></div></div>'+
                                    '<div id="lineTime_'+i.layer+'_label" class="labelLineTime" align="left">'+i.label+' ('+actualYear+')</div>'+
                                    '<div class="lineTimeSlider">'+
                                        '<div id="lineTime_'+i.layer+'_slider" class="slider"></div>'+
                                    '</div>'+
                        '</div>';
        }
		return cadena;
    };
    
    var getVisibleLayers = function(){
        var result = null;
		var layers = getSource();
        for(x in layers){
            if(layers[x].visible){
                if(result==null){
                    result=[];
                }
                result.push(x);
            }
        }
        return result;
    };
    var setParamsToTimeLine = function(){
        var layers = getVisibleLayers();
        if(layers!=null){
            layers = layers.toString();
        }else{
            layers='';
        }
        data.Map.setParamsToLayer({
                layer:'lineTime',
                params:{layers: layers}
        });
    };
    var addImage = function(){
        var p = arguments[0];
        if(p.time== ''){
                var path = p.server+
				"&LAYERS=cusv5&TRANSPARANT=true&FORMAT=image/png&SERVICE=WMS&VERSION=1.1.1&"+
				"REQUEST=GetMap&STYLES=&FIRM=11&SRS=EPSG:900913&BBOX="+p.extent+"&WIDTH="+p.width+"&HEIGHT="+p.height+"&TIME="+p.time;        
                    }else{
				var path = p.server+
				"&LAYERS="+p.time+"&TRANSPARANT=true&FORMAT=image/png&SERVICE=WMS&VERSION=1.1.1&"+
				"REQUEST=GetMap&STYLES=&FIRM=11&SRS=EPSG:900913&BBOX="+p.extent+"&WIDTH="+p.width+"&HEIGHT="+p.height+"&TIME="+p.time;
		}
		
        var hidden = (p.hidden)?'display:none':'';
        var cadena = '<img id="lineTime_image_'+p.year+'_'+p.time+'" style="position:absolute;left:0px;'+hidden+'"  src="'+path+'">';
        var map = $("#"+p.root).append(cadena);
        $('#lineTime_image_'+p.year+'_'+p.time).bind('load', function() {
            checkImageLoading();
        });
    };
    var getContent = function(){
	
        var a = arguments[0];
        var cadena = '';
        cadena = getSections(a);
        cadena+='<div id="lineTime_years" style="position:absolute;top:25px;left:18px;right:12px;bottom:5px;z-index:-1"></div>';
        cadena+= '<div id="lineTime_separator" style="height:20px;padding-left:12px;padding-right:12px;">'+//width:300px;
                '</div>';
		return cadena;
    };
    
    var getInterface = function(){
        var a = arguments[0];
        var chain = '<div id="'+a.data.id+'" style="display:none" class="'+a.data.clase+'">'+
                        '<div align="center" class="titleOL" style="border-bottom:solid #CCCCCC 2px;">'+
                            '<div align="left" id="'+a.data.id+'_title">'+a.data.title+'</div>'+
                            '<span title="cerrar" id="lineTime_'+a.data.id+'_btnClose" class="closeLineTime ui-icon ui-icon-circle-close"></span>'+
                        '</div>'+
                        '<div align="center" class="contOL">'+
                            a.content+
                        '</div>'+
                    '</div>';
		console.log(chain);
        return chain;
    };
    var showPopupYearSections = function(){
        var a = ['1990','2000','2010','2020'];
        //var a = data.years.availables;
        var contenido = '';
        var sections=0;
        for(x in a){
            contenido+=getSectionYearPopup(a[x]);
            if(x<(a.length-1)){
                contenido+=getSectionSeparatorPopup();
            }
            sections+=2;
        }
        sections-=1;
        //console.log("Las secciones son " + sections);
        var segmento =data.years.width;
        var borderPixel = 2;
        $("#lineTime_years").html('').append(contenido);
        $("#lineTime_separator").css('width',(((segmento+borderPixel)*sections))+"px");
        
        $(".lineTimeSlider").each(function(){
            var id = $(this).children('div').attr('id');
            var lon = id.length-7;
            id = id.substring(9,lon);
            var anio = parseInt(a[0]);
            var cadena = '';
            for(var x=1;x<56;x++){
                cadena+=getYearsNotAvailables(anio,10,id);
                //console.log(cadena);
                anio+=1;
            }
            $(this).css('')
            $(this).children('div').append(cadena);
        });
    };
    var assingEvents = function(){
        $(".slider").each(function(){
            var year = 1990;
            var id = $(this).attr('id');
            var lon = id.length-7;
            id = id.substring(9,lon);
            $(this).slider({
                value:51,
                min: 0,
                max: 54,
                step: 1,
                slide: function( event, ui ) {
                    var etiqueta = data.layers.availables[id].label+" ("+(year+ui.value)+")";
                    $("#lineTime_"+id+"_label").html(etiqueta);
                },
                stop:function(event, ui){
                    var response={dates:'',layer:id};
                    var items = data.request.data[id].data[year+ui.value];
                    if(items){
                        //response.dates=items[0] + "/"+items[items.length-1];
                        response.dates=items[0];
                    }else{
                    //////////////////
                        var anio = parseInt(year+ui.value);
                        var origen = data.request.data[id].data;
                        var newanio = 0;
                        for(x in origen){
                            var a = parseInt(x);
                            if(a<anio){
                                newanio=a;
                            }
                        }
                        if(newanio==0){
                            for(x in origen){
                                var a = parseInt(x);
                                newanio=a;
                                break;
                            }
                        }
                        var position = newanio-year;
                        $('#lineTime_'+id+'_slider').slider( "value", position );
                        items = data.request.data[id].data[year+position];
                        response.dates=items[0];
                    }
                    ///////////////////
                        
                        var newLayer = response.dates;
                        var fuente = data.Tree.getTemporalStore();
                        var position = fuente.Vectorial.item[id];
                        var grupo = fuente.Vectorial.position[position].group;
                        var params = [{id:id,active:true,group:grupo}];
                        data.Tree.addToRepository(params);
                    
                }
            });
            $(this).slider('disable');
		
            
        });
        $("#lineTime_"+data.popup.id+"_btnClose").click(function(){
                toggleVisibility(data.popup);
        });
        $(".playLineTime").each(function(){
            $(this).click(function(){
                var layer = $(this).attr('id').replace('lineTime_','');
                showModal(layer);
            });
        });
        $("#"+data.idBtn).click(function(){
            if(data.popup.enable){
                toggleVisibility(data.popup);
            }
        });
        showPopupYearSections();
        var registro={flag:true,id:'',slider:''};
        $(".lineTime_view").each(function(){
            
            var reg = jQuery.extend({},registro);
            reg.id = $(this).children().attr('id');
            reg.id = reg.id.replace('lineTime_view_','');
            reg.flag = (data.layers.availables[reg.id].visible);
            reg.slider = 'lineTime_'+reg.id+'_slider';
            $(this).children().click(function(){
                var item = $(this);
                reg.flag = !reg.flag;
                statusDisabled({layer:reg.id,slider:reg.flag,play:true,eye:true,visible:reg.flag,disable:true});
                if(!reg.flag){
                    item.removeClass('layerDisplay-iconEye_a').addClass('layerDisplay-iconEye_d');
                }else{
                    item.removeClass('layerDisplay-iconEye_d').addClass('layerDisplay-iconEye_a');
                }
                $("#"+reg.id).click();
                setParamsToTimeLine();
            });
        });
    };
    
    var visibilityLayerTime =function(id,status){
        var source = data.layers.availables;
        if(source[id]){
            source[id].visible = status;
            var item = $("#lineTime_view_"+id);
            if(!status){
                    item.removeClass('layerDisplay-iconEye_a').addClass('layerDisplay-iconEye_d');
                    toggleVisibility(data.popup);
            }else{
                    item.removeClass('layerDisplay-iconEye_d').addClass('layerDisplay-iconEye_a');
            }
            data.popup.enable=status;
            statusDisabled({layer:id,eye:true,play:true,slider:status,visible:status});
        }
    };
    
    var stop = function(){
        $("#lineTime_btn_animation").removeClass('icon_stop').addClass('icon_play');
        $("#slider-modal" ).draggable( "enable").removeClass('lineTime_slider_modal_disabled');
        
    };
    var play = function(){
        var info = data.modal.images;
        var images = data.request.data[info.layer].data;
        if((info.years[info.pos])&&(data.modal.animation)){
            var year = info.years[info.pos];
            if(images[year][info.image]){
                $("#"+info.last).fadeOut();
                var imagen = images[year][info.image];
                var id = 'lineTime_image_'+year+'_'+imagen;
                $("#"+id).fadeIn();
                info.last=id;
                $("#slider-modal").css('left',info.positions[year][info.image].position+"px");
                info.image+=1;
            }else{
                info.pos+=1;
                info.image=0;
            }
            setTimeout(function(){
                play();
            },1000);
               
        }else{
            info.image=0;
            info.pos=0;
            stop();
        }
    };
    
    var assingEventsModal = function(){
        $("#lineTime_"+data.modal.id+"_btnClose").click(function(){
            if(data.modal.animation){
                $("#lineTime_btn_animation").click();
            }
            $("#"+data.modal.id+",#"+data.blocker.id).hide();
            
        });
        $("#lineTime_btn_animation").click(function(){
            data.modal.animation=!data.modal.animation;
            if(data.modal.animation){
                $(this).removeClass('icon_play').addClass('icon_stop');
                $("#slider-modal" ).draggable( "disable").addClass('lineTime_slider_modal_disabled');
                play();
            }else{
                stop();
            }
        });
    };
    var getSource = function(){
        return data.layers.availables;
	};
    var toggleVisibility = function(){
        var a = arguments[0];
        a.visible=!a.visible;
        $("#"+a.id).toggle(a.visible);
        if(a.visible){
            execute();
        }
    };
    var addComponents = function(){
        var source = getSource();
        var params = {data:data.popup,content:getContent(source)};
        $("#"+data.root).append(getInterface(params));
    };
    var getContentModal = function(){
        var dims = getDimentionsFromMap();
        var cadena ='<div style="padding-top:5px;padding-bottom:2px;padding-left:2px;padding-right:2px;">'+
                        '<div style="background:#DCDDDF;padding-top:5px;padding-left:10px;padding-right:10px;padding-bottom:10px;">'+
                            '<div id="'+data.map.div+'" style="width:'+dims.width+'px;height:'+dims.height+'px;background:white;position:relative;">'+
                                //'<div id="'+data.map.div+'_base" style="width:'+dims.width+'px;height:'+dims.height+'px;position:absolute:top:0px;">'+
                            '</div>'+
                        '</div>'+
                    '</div>'+
                    '<div style="height:50px;padding-top:10px">'+
                        '<div style="float:left;height:100%;width:9%">'+
                            '<div style="padding-top:8px">'+
                                '<div  id="lineTime_btn_animation" class="lineTime_icons icon_play"></div>'+
                            '</div>'+
                        '</div>'+
                        '<div style="position:relative;float:left;height:100%;width: 90%;border: 2px solid #BBBCC0;">'+
                        '<div id="lineTime_modal" style="position:absolute;top:5px;left:5px;right:5px;bottom:5px;"></div>'+
                        '</div>'+
                        '<div id="lineTime_blocker" style="position:absolute;bottom:10px;left:10px;right:10px;top:30px;background:#DCDDDF;padding-top:5px;padding-left:10px;padding-right:10px;padding-bottom:10px;">'+
                            '<div style="background:white;height:100%;">'+
                                '<div style="font-size:170%;padding-top:20%;padding-right:20%;padding-left:20%">'+
                                    '<img src="img/spinner.gif">'+
                                    '<div style="border-bottom: 10px solid #DDDDDD">Cargando animaci&oacute;n</div>'+
                                '</div>'+
                            '</div>'+
                        '</div>'+
                    '</div>';
        return cadena;
    };
    var clearYears = function(){
        $(".lineTime_year").each(function(){
            $(this).css('background','white');
        });
    };
    
    var statusDisabled = function(){//{layer:x,slider:true,play:true,view:true}
        var a = arguments[0];
        var layer = a.layer
        var item = data.layers.availables[a.layer];
        var status = 'disable';
        if(a.slider){
           status = 'enable';
        }
        $("#lineTime_"+a.layer+"_slider").slider(status);
        
        if(a.play){
            $("#lineTime_"+layer).show();
        }else{
            $("#lineTime_"+layer).hide();
        }
        if(a.eye){
            $("#lineTime_view_"+layer).show();
        }else{
            $("#lineTime_view_"+layer).hide();
        }
        if(a.visible!=undefined){
            item.visible = a.visible;
        }
        item.enable = a.disable;
        if(item.visible==false){
            $("#lineTime_"+a.layer+"_slider").slider('disable');
        }
    };
    var showYearsAvailables = function(){
        var items = arguments[0];
        data.request.data = items;
        clearYears();
        for(x in items){
                var segment = items[x];
                var paramsDisabled = {layer:x,slider:true,play:true,eye:true,disable:true};
                if(items[x]==null){
                    paramsDisabled={layer:x,slider:false,play:false,eye:false,disable:false};
                }
                statusDisabled(paramsDisabled);
                for(e in segment){
                    var years = segment[e];
                    for(y in years){
                        if(y!='0001'){
                            $("#lineTime_"+x+"_year_"+y).css('background','gray');
                        }
                    }
                }
        }
    };
    var getDimentionsFromMap = function(){
        var percent = data.map.percent;
        var map = $("#map");
        var width = map.width();
        var height = map.height();
        var newWidth = (percent*width)/100;
        var newHeight = (percent*height)/100;
        return {width:newWidth,height:newHeight};
    };
    var showModal = function(){
        $("#lineTime_blocker").show();
        var a = arguments[0];
        var m = data.modal;
        if(!m.created){
            var params = {data:m,content:getContentModal()};
            var blocker = '<div id="'+data.blocker.id+'" class="ui-widget-overlay" style="z-index:3000"></div>';
            $("#"+data.root).append(blocker).append(getInterface(params));
            //Map.init();
            assingEventsModal();
            m.created=true;
        }
        m.visible=false;
        var branch = data.layers.availables;//data.layers.get();
        $("#"+data.modal.id+"_title").html(data.modal.title+'<label style="font-weight:bold;">'+branch[a].label+'</label>');
        toggleVisibility(m);
        //Map.setParams({layers:a});
        builSecuenceImages(a);
        buildLineTimeModal(a);
        $("#"+data.blocker.id).show();
    };
    var makeConection = function(){
        var p = arguments[0];
        var params = {tablas:p.layers,proyName:dataSource.proyName/*'mdm5'*/,extent:p.extent};
        request.setParams(JSON.stringify(params));
        request.execute();
    };
    var getSectionYearPopup = function(){
        var cadena = '<div style="position:relative;float:left;width:'+data.years.width+'px;height:100%;border: 1px solid #DDDDDD;">'+
                        '<div style="position:absolute;top:0px;left:5px;right:5px;bottom:0px;background:#EEF0EF;"></div>'+
                        '<div style="position:absolute;bottom:0px;right:0px;left:0px;background:#BBBCC0;">'+arguments[0]+'</div>'+
                    '</div>';
        return cadena;
    };
    var getSectionSeparatorPopup = function(){
        return '<div style="position:relative;float:left;width:'+data.years.width+'px;height:100%;border: 1px solid #FFFFFF;"></div>';    
    };
    var getYearsNotAvailables = function(){
        var cadena = '<div id="lineTime_'+arguments[2]+'_year_'+arguments[0]+'" class="lineTime_year" style="float:left;position:relative;width:'+arguments[1]+'px;height:8px;z-index:1"></div>';
        return cadena;
    };
    var checkImageLoading = function(){
        var info = data.modal.images; 
        info.loaded+=1;
        if(info.loaded == (info.total+1)){
           $("#lineTime_blocker").fadeOut();
        }
    };
    
    var calculateExtent = function(){
        var factorLon = 2800000;
        var factorLat = 2100000;
        var centroid = data.Map.map.getCenter();
        var px2 = centroid.lon+factorLon;
        var py2 = centroid.lat+factorLat;
        var px1 = centroid.lon-factorLon; 
        var py1 = centroid.lat-factorLat;
        return px1+','+py1+','+px2+','+py2;
    };
    var builSecuenceImages = function(){
        var layer = arguments[0];
        var map = $("#lineTime_map");
        map.html('');
        //var extent = calculateExtent();
        var extent = data.Map.map.getExtent();
        var source = data.request.data[layer].data;
        var width = map.width();
        var height = map.height();
        var extentImage = extent.left+','+extent.bottom+','+extent.right+','+extent.top;//extent;//
        var years = [];
        for(x in source){
            if(x!='0001'){
                years.push((x*1));
            }
        }
        data.modal.images.loaded=0;
        data.modal.images.total=0;
        var params ={
                    root:'lineTime_map',
                    server:config.mapConfig.timeLine.base.url,
                    layer:config.mapConfig.timeLine.base.layer,
                    width:width,
                    height:height,
                    extent:extentImage,
                    year:'base',
                    time:'',
                    hidden:false
                }
        addImage(params);
        for(x in years){
            var images = source[years[x]];
            for(i in images){
                var params ={
                    root:'lineTime_map',
                    server:data.map.server,
                    layer:layer,
                    width:width,
                    height:height,
                    extent:extentImage,
                    year:years[x],
                    time:images[i],
                    hidden:true
                }
                addImage(params);
                data.modal.images.total+=1;
            }   
        }
        data.modal.images.layer=layer;
        data.modal.images.years=years;
        //Map.map.zoomExtent(extent);
    };
    var buildLineTimeModal = function(){
        var positions = {};
        var layer = arguments[0];
        var source = data.request.data[layer].data;
        $("#lineTime_modal").html('');
        var width = ($("#lineTime_modal").width())-4;
        var arreglo = [];
        var arregloPositions=[];
        for(x in source){
            if(x!='0001'){
            arreglo.push((x*1))
            }
        }
        var segmento = width/arreglo.length;
        var cadena='';
        var counter=0;
        var bandera = true;
        for(x in arreglo){
            bandera=!bandera;
            var color=(bandera)?'white':'#C9C8CD';
            var colorinsider = (bandera)?'#CBCCCE':'#A3A4A8';
            cadena+='<div style="position:relative;float:left;width:'+segmento+'px;height:100%;background:'+color+'">'+
                '<div style="padding-top:14px;"><div style="background:'+colorinsider+'">'+arreglo[x]+'</div></div>'+
            '</div>';
            var items = data.request.data[layer].data[arreglo[x]];
            var regs = [];
            for(i in items){
                counter+=segmento/items.length;
                var registro = {position:counter,item:items[i],year:arreglo[x]};
                arregloPositions.push(registro);
                regs.push(registro);
            }
            positions[arreglo[x]]=regs;
        }
        data.modal.images.positions = positions;
        var slider = '<div id="slider-modal" style="position: absolute; top: -6px; width: 20px; height: 52px;">'+
                            '<div style="position:absolute;background:white;top:0px;left:0px;right:0px;height:19px;border: 1px solid black;">'+
                                '<div style="position:absolute;top:0px;right:4px;left:3px;bottom:3px;background:gray"></div>'+
                            '</div>'+
                            '<div style="position:absolute;background:white;bottom:0px;left:0px;right:0px;height:18px;border: 1px solid black;">'+
                                '<div style="position:absolute;top:3px;right:4px;left:3px;bottom:0px;background:gray"></div>'+
                            '</div>'+
                    '</div>';
        
        $("#lineTime_modal").html(cadena+slider);
        $("#slider-modal").draggable({ axis: "x" ,containment: "#lineTime_modal",cursor:'pointer',stop: function( event, ui ) {
            var result=null;
            for(x in arregloPositions){
                if(ui.position.left<=arregloPositions[x].position){
                    result=arregloPositions[x];
                    break;
                }
            }
            if(result!=null){
                $("#"+data.modal.images.last).fadeOut();
                var id = 'lineTime_image_'+result.year+'_'+result.item;
                $("#"+id).fadeIn();
                data.modal.images.last=id;
            }
        }});
        
    };
    var setMovedMap =function(){
        data.map.moved = arguments[0];
    };
    var execute = function(){
        if((data.timer)&&(data.popup.visible)&&(data.map.moved)){
            data.timer.execute();
        }
    };
    var spetialModule = function(capas){
        var year = 1990;
        var layers = capas.split(',');
        var source = data.layers.availables;
        var positions = [];
		for(x in layers){
            if(source[layers[x]]){
                if(source[layers[x]].visible){
                    replace = true;
                    var valor = $('#lineTime_'+layers[x]+'_slider').slider( "option", "value" );
                    var newLayer = data.request.data[layers[x]].data[year+valor];
                    if(newLayer){
                            capas = capas.replace(layers[x],newLayer[0]);
                    }else{
                        positions.push(x);
                    }
                    
                }
            }
        }
        if(positions.length>0){
            for(var i = positions.length;i>=0;i--){
                layers.splice(positions[i],1);
                capas = layers.toString();
            }
            
        }
		console.log(positions);
		return capas;
    };
	 var addLayers = function(){
        var layers = data.layers.availables;
        for(var x in layers){
            var layer = x;
            var lastPosition = data.Map.map.layers.length;
            var template = {
                type:'WMS',
                name:layer,
                url:config.mapConfig.timeLine.layers,
                isBase:false,
                position:lastPosition,
                info:{
                    layers:layer,
                    format:'png'
                },
                params:{
                    tiled:false,
                    effect:false,
                    buffer:0,
                    ratio:1
                }
            };
            //console.log(template);
            data.Map.addLayer(template);
        }
    };
    
	 
		 
	
    var init = function(){
        data.Map = arguments[0];
        data.Tree = arguments[1];
        addComponents();
        assingEvents();
        defineTimer();
        execute();
		
        data.timer.execute();
    };
    return{
		load:init,
        execute:execute,
        addLayerAvailable:data.layers.addAvailable,
        getLayers:getVisibleLayers,
        setMovedMap:setMovedMap,
        setVisibilityLayerTime:visibilityLayerTime,
        spetialModule:spetialModule
    };
});
